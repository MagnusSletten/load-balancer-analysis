services:
  app1:
    build: ./app
    expose: ["8000"]
    ports: ["8001:8000"]
    environment:
      - GUNICORN_WORKERS=1

  app2:
    build: ./app
    expose: ["8000"]
    environment:
      - GUNICORN_WORKERS=1

  app3:
    build: ./app
    expose: ["8000"]
    environment:
      - GUNICORN_WORKERS=1

  app4:
    build: ./app
    expose: ["8000"]
    environment:
      - GUNICORN_WORKERS=1

  app5:
    build: ./app
    expose: ["8000"]
    environment:
      - GUNICORN_WORKERS=1

  nginx:
    image: nginx:1.27-alpine
    depends_on: [app1, app2, app3, app4, app5]
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8082:8082"  # round-robin
      - "8083:8083"  # least-connections

  sender:
    build: ./sender
    depends_on: [nginx]
    environment:
      - TARGET_RR=http://nginx:8082/calculate
      - TARGET_LC=http://nginx:8083/calculate

      # steady-stream test (unchanged)
      - DURATION_SEC=60
      - JOB_MODE=cycle            # or "weighted"
      - JOBS=A,B,C,D
      - JOB_WEIGHTS=C:6,E:3,A:1   # only used if JOB_MODE=weighted
      - REQUEST_TIMEOUT_SEC=120
      - CONCURRENCY=5            # threads for both stream + batch
      - TARGET_RPS=0              # 0 = unlimited

      # Batched-burst test (fixed total requests per batch)
      - RUN_STREAM=1
      - RUN_BATCH=1
      - BATCH_COUNT=7            # number of batches to run
      - BATCH_REQUESTS=8        # <-- total requests per batch (large)
      # (BATCH_MIN/BATCH_MAX are no longer needed and can be removed)

      # Optional niceties
      - START_DELAY_SEC=12
      - COOLDOWN_SEC=20
